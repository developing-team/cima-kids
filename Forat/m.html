<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
    <div class="navbar">
        <div class="navbar-container">
            <div class="logo-container">
                <img src="./img/logo.png" alt="Logo" width="80px" height="80px" />
            </div>
            <div class="menu-container">
                <ul class="menu-list">
                    <a href=""><li class="menu-list-item active">Home</li></a>
                    <a href=""><li class="menu-list-item">Movies</li></a>
                    <a href=""><li class="menu-list-item">Series</li></a>
                    <a href=""><li class="menu-list-item">Popular</li></a>
                    <a href=""><li class="menu-list-item">Trends</li></a>
                </ul>
            </div>
            <div class="profile-container">
                <div class="toggle">
                    <i class="fas fa-moon toggle-icon"></i>
                    <i class="fas fa-sun toggle-icon"></i>
                    <div class="toggle-ball"></div>
                </div>
            </div>
            <div class="hamburger-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </div>
    <div class="container text-center">
        <div class="cont">
            <div class="row">
                <div class="col">
                    <img alt="" class="imagee">
                </div>
                <div class="col">
                    <div class="circle-container">
                        <div class="circle"><a href="#name">Name</a></div>
                        <div class="circle"><a href="#Comment">Leave a Comment</a></div>
                    </div>
                    <div class="part-text">
                        <h3>Toy Story</h3>
                        <p>The story of the legendary British outlaw portrayed with the characters as anthropomorphic animals.</p>
                        <span class="poster">8.3</span>
                        <span class="date">1999</span>
                        <div class="icon"><i class="fa-regular fa-circle-play fa-2xl" style="color: #1f3951;"></i> watch it </div>
                        <section id="Comment">
                            <div id="commentsList">
                                <!-- ستضاف التعليقات هنا -->
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </div>
        <section id="LeaveComment">
            <div class="comment-box">
                <h3 style="text-align: left;">Leave A Comment</h3>
                <form id="commentForm">
                    <div class="row">
                        <div class="col-xl-6 col-lg-6">
                            <input type="text" id="nameInput" placeholder="Enter Your Name">
                            <span></span>
                        </div>
                        <div class="col-xl-6 col-lg-6">
                            <input type="email" id="emailInput" placeholder="Enter Your Email">
                            <span></span>
                        </div>
                        <div class="col-xl-6 col-lg-6">
                            <textarea id="messageInput" placeholder="Write a Message"></textarea>
                            <span class="textarea"></span>
                        </div>
                        <div class="col-xl-12 col-lg-12">
                            <button type="submit" id="sendButton">Send Us Now</button>
                        </div>
                    </div>
                </form>
            </div>
        </section><br><br><br>
    </div>
    <!-- إعداد Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
        import { getDatabase, ref, push, set, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCiL9I5hokjct0j1WiLg5ZB0erVv094aiw",
            authDomain: "cima-kids.firebaseapp.com",
            databaseURL: "https://cima-kids-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "cima-kids",
            storageBucket: "cima-kids.appspot.com",
            messagingSenderId: "324919675126",
            appId: "1:324919675126:web:af1fb7392f829b2f2104d7",
            measurementId: "G-WZHXGFQLY0"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const database = getDatabase(app);
        const auth = getAuth();

        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
            } else {
                currentUser = null;
            }
        });

        const urlParams = new URLSearchParams(window.location.search);
        const movie_id = urlParams.get('movie_id');

        function retrieveData() {
            const movieRef = ref(database, `movies/${movie_id}`);
            onValue(movieRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.querySelector('h3').innerText = data.title;
                    document.querySelector('.part-text p').innerText = data.description;
                    document.querySelector('.poster').innerText = data.rate;
                    document.querySelector('.date').innerText = data.year;
                    document.querySelector('.imagee').src = data.image_url;
                } else {
                    console.error("No data found");
                }
            });
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            retrieveData();
            retrieveComments();
        });

        function saveComment(movieId, comment) {
            const commentsRef = ref(database, `movies/${movieId}/comments`);
            const newCommentRef = push(commentsRef);
            set(newCommentRef, {
                ...comment,
                userId: currentUser.uid // إضافة معرف المستخدم للتعليق
            });
        }

        function deleteComment(movieId, commentKey) {
            const commentRef = ref(database, `movies/${movieId}/comments/${commentKey}`);
            commentRef.remove();
        }

        function updateComment(movieId, commentKey, updatedComment) {
            const commentRef = ref(database, `movies/${movieId}/comments/${commentKey}`);
            commentRef.set(updatedComment);
        }

        function retrieveComments() {
            const commentsRef = ref(database, `movies/${movie_id}/comments`);
            onValue(commentsRef, (snapshot) => {
                const comments = snapshot.val();
                if (comments) {
                    const commentsList = document.getElementById('commentsList');
                    commentsList.innerHTML = '';
                    Object.entries(comments).forEach(([key, comment], index) => {
                        const commentElement = document.createElement('div');
                        commentElement.classList.add('single-comment');
                        commentElement.setAttribute('data-user-id', comment.userId); // تعيين معرف المستخدم للتعليق
                        if (index >= 1) {
                            commentElement.classList.add('single-comment-hidden');
                        }
                        commentElement.innerHTML = `
                            <div class="part-img">
                                <img src="assets/img/use.jpg" alt="">
                            </div>
                            <div class="part-text">
                                <span class="commentor-name">${comment.name}</span>
                                <p>${comment.message}</p>
                                <button class="edit-btn" data-key="${key}">Edit</button>
                                <button class="delete-btn" data-key="${key}">Delete</button>
                            </div>
                        `;
                        commentsList.appendChild(commentElement);
                    });

                    document.querySelectorAll('.edit-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const commentKey = event.target.getAttribute('data-key');
                            const commentElement = event.target.closest('.single-comment');
                            const commentUserId = commentElement.getAttribute('data-user-id');

                            if (currentUser.uid === commentUserId) {
                                const commentText = event.target.previousElementSibling.textContent;
                                const commentName = event.target.previousElementSibling.previousElementSibling.textContent;
                                document.querySelector('#nameInput').value = commentName;
                                document.querySelector('#messageInput').value = commentText;
                                document.querySelector('#emailInput').dataset.key = commentKey;
                                document.querySelector('#sendButton').textContent = 'Update Comment';
                            } else {
                                alert('You can only edit your own comments.');
                            }
                        });
                    });

                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const commentKey = event.target.getAttribute('data-key');
                            const commentElement = event.target.closest('.single-comment');
                            const commentUserId = commentElement.getAttribute('data-user-id');

                            if (currentUser.uid === commentUserId) {
                                deleteComment(movie_id, commentKey);
                            } else {
                                alert('You can only delete your own comments.');
                            }
                        });
                    });
                } else {
                    console.log('No comments found');
                }
            });
        }

        const commentForm = document.getElementById('commentForm');
        commentForm.addEventListener('submit', (event) => {
            event.preventDefault();

            const nameInput = document.getElementById('nameInput').value;
            const emailInput = document.getElementById('emailInput').value;
            const messageInput = document.getElementById('messageInput').value;
            const commentKey = document.getElementById('emailInput').dataset.key;

            if (currentUser) {
                const newComment = {
                    name: nameInput,
                    email: emailInput,
                    message: messageInput,
                    userId: currentUser.uid // إضافة معرف المستخدم للتعليق
                };

                if (commentKey) {
                    updateComment(movie_id, commentKey, newComment);
                    document.querySelector('#sendButton').textContent = 'Send Us Now';
                } else {
                    saveComment(movie_id, newComment);
                }

                commentForm.reset();
            } else {
                alert('You must be logged in to leave a comment.');
            }
        });
    </script>
</body>
</html>
